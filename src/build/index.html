<!doctypehtml><html><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1"name=viewport><title>goldfish</title><style>*{margin:0;padding:0}body,html{width:100%;height:100%;overflow:hidden;background:#141e3c}canvas{display:block;position:absolute;top:0;left:0}#status{position:fixed;top:10px;left:10px;color:#fff;font-family:monospace;font-size:12px;background:rgba(0,0,0,.5);padding:5px 10px;border-radius:4px;pointer-events:none}</style></head><body><canvas id=canvas oncontextmenu=event.preventDefault()></canvas><div id=status>Loading...</div><script src=https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js></script><script src=renderer.js></script><script>var renderer=null,foodPosPtr=null,MAX_FOOD=32,Module={canvas:document.getElementById("canvas"),print:function(e){console.log(e)},printErr:function(e){console.error(e)},onRuntimeInitialized:function(){initRenderer(),initBrain()}};function initRenderer(){var e=document.getElementById("canvas");renderer=new Renderer(e),foodPosPtr=Module._malloc(2*MAX_FOOD*4),handleResize(),requestAnimationFrame(renderLoop),e.addEventListener("click",(function(e){Module._drop_food(e.clientX,e.clientY)}))}function handleResize(){var e=window.innerWidth,o=window.innerHeight;renderer.resize(e,o)}function renderLoop(){if(renderer){var e=Module._get_food_count();Module._get_food_positions(foodPosPtr);for(var o=new Float32Array(2*e),n=0;n<2*e;n++)o[n]=Module.getValue(foodPosPtr+4*n,"float");renderer.clear(),renderer.drawFood(o,e);for(var r=Module._get_fish_count_sim(),t=0;t<r;t++){var i=Module._get_x_for_fish(t),a=Module._get_y_for_fish(t),d=Module._get_angle_for_fish(t),s=Module._get_tail_phase_for_fish(t),l=Module._get_tail_amplitude_for_fish(t),u=Module._get_body_curve_for_fish(t),c=Module._get_left_pectoral_for_fish(t),m=Module._get_right_pectoral_for_fish(t);renderer.drawFish(i,a,d,s,l,u,c,m)}requestAnimationFrame(renderLoop)}else requestAnimationFrame(renderLoop)}window.addEventListener("resize",handleResize);var brain=null,brainEnabled=!1,obsPtr=null,OBS_SIZE=56;function setStatus(e){document.getElementById("status").textContent=e}async function initBrain(){setStatus("Initializing..."),obsPtr=Module._malloc(4*OBS_SIZE);try{if("undefined"!=typeof FishBrain)brain=new FishBrain,await brain.init("model.onnx"),brainEnabled=!0,setStatus("AI Brain Active - Click to add food"),console.log("Brain loaded successfully"),requestAnimationFrame(brainLoop);else{const e=await ort.InferenceSession.create("model.onnx");brain={session:e},brainEnabled=!0,setStatus("AI Brain Active - Click to add food"),console.log("ONNX model loaded directly"),requestAnimationFrame(brainLoop)}}catch(e){console.log("Brain not available:",e.message),setStatus("Manual: WASD/Arrows=move, Shift=burst, Click=food, B=toggle AI"),brainEnabled=!1,requestAnimationFrame(manualLoop)}}var brainFrameCount=0,LOG_INTERVAL=60;async function brainLoop(){if(brainEnabled&&brain){try{Module._get_observation(obsPtr);for(var e,o=new Float32Array(OBS_SIZE),n=0;n<OBS_SIZE;n++)o[n]=Module.getValue(obsPtr+4*n,"float");if(brain.predict)e=await brain.predict(o);else{var r=new ort.Tensor("float32",o,[1,OBS_SIZE]),t=(await brain.session.run({observation:r})).action.data;e={speed:t[0],direction:t[1],urgency:t[2]}}brainFrameCount%LOG_INTERVAL==0&&(console.log("=== Frame",brainFrameCount,"==="),console.log("Input obs[0:32] (raycasts):",Array.from(o.slice(0,32)).map((e=>e.toFixed(2))).join(", ")),console.log("Input obs[32:48] (lateral):",Array.from(o.slice(32,48)).map((e=>e.toFixed(2))).join(", ")),console.log("Input obs[48:51] (proprio):",Array.from(o.slice(48,51)).map((e=>e.toFixed(2))).join(", ")),console.log("Input obs[51] (hunger):",o[51].toFixed(2)),console.log("Output action:",{speed:e.speed.toFixed(3),direction:e.direction.toFixed(3),urgency:e.urgency.toFixed(3)})),brainFrameCount++,Module._set_action(e.speed,e.direction,e.urgency)}catch(e){console.error("Brain inference error:",e)}requestAnimationFrame(brainLoop)}}var keysDown={},wanderDirection=0,wanderSpeed=.9,smoothDirection=0,smoothSpeed=.9,wanderTimer=0;function manualLoop(){if(!brainEnabled){++wanderTimer%30==0&&(wanderDirection+=.3*(Math.random()-.5),wanderDirection*=.9,wanderDirection=Math.max(-.5,Math.min(.5,wanderDirection)),wanderSpeed+=.1*(Math.random()-.5),wanderSpeed=Math.max(.75,Math.min(1,wanderSpeed)));var e=smoothSpeed+=.03*(wanderSpeed-smoothSpeed),o=smoothDirection+=.05*(wanderDirection-smoothDirection),n=.5+.4*smoothSpeed;(keysDown.w||keysDown.ArrowUp||keysDown.a||keysDown.ArrowLeft||keysDown.d||keysDown.ArrowRight||keysDown.s||keysDown.ArrowDown)&&(o=0,(keysDown.w||keysDown.ArrowUp)&&(e=.8,n=.6),(keysDown.a||keysDown.ArrowLeft)&&(o=-.7),(keysDown.d||keysDown.ArrowRight)&&(o=.7),(keysDown.s||keysDown.ArrowDown)&&(e=.1,n=.1)),keysDown.Shift&&(n=1,e>.5&&(e=1)),Module._set_action(e,o,n),requestAnimationFrame(manualLoop)}}document.addEventListener("keydown",(function(e){keysDown[e.key]=!0,"b"!==e.key&&"B"!==e.key||((brainEnabled=!brainEnabled)&&brain?(setStatus("AI Brain Active - Click to add food"),requestAnimationFrame(brainLoop)):(setStatus("Manual: W/↑=swim, S/↓=brake, A/D=turn, Shift=burst, B=toggle AI"),requestAnimationFrame(manualLoop)))})),document.addEventListener("keyup",(function(e){keysDown[e.key]=!1}))</script><script src=index.js async></script></body></html>